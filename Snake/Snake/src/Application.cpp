#include "Application.hpp"

#include <iostream>

using std::cout;
using std::endl;
using std::cerr;

Application::Application(const std::string& title)
	:m_window(std::make_shared<sf::RenderWindow>(sf::VideoMode(800, 600), title, sf::Style::Titlebar | sf::Style::Close)),
	m_stateManager(std::make_shared<StateManager>()),
    m_resourceManager(std::make_shared<ResourceManager>())
{
    m_resourceManager->loadResources();
    m_stateManager->init(m_window, m_resourceManager);

    setIcon();

	m_window->setVerticalSyncEnabled(true);
}

Application::~Application()
{
}

void Application::run()
{
	sf::Clock clock;
	sf::Time stepTime;

	const sf::Time TIME_PER_FRAME = sf::seconds(1.0f / 60.0f);

    m_stateManager->startTheMusic();

    while(m_window->isOpen())
    {
        stepTime += clock.restart();

        // Fixed time step loop
        while(stepTime >= TIME_PER_FRAME)
        {
			processEvents();
			processInput();
			update(TIME_PER_FRAME);

            stepTime -= TIME_PER_FRAME;
        }
        render();
    }
}

void Application::processEvents()
{
    m_stateManager->processEvents();
}

void Application::processInput()
{
	m_stateManager->processInput();
}

void Application::update(sf::Time elapsedTime)
{
	m_stateManager->update(elapsedTime);
}

void Application::render()
{
	m_stateManager->render();
}

void Application::setIcon()
{
    const struct {
        unsigned int 	 width;
        unsigned int 	 height;
        unsigned int 	 bytes_per_pixel; /* 2:RGB16, 3:RGB, 4:RGBA */
        unsigned char	 pixel_data[32 * 32 * 4 + 1];
    } gimp_image = {
      32, 32, 4,
      "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000"
    "\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
    "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000"
    "\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377"
    "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214"
    "\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214"
    "\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377"
    "\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353"
    "\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\310\000\377\000\310\000\377"
    "\000\310\000\377\000\310\000\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\377\000\000\377\377\000\000\377\377\000\000\377\377\000\000\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377"
    "\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353"
    "\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\310\000\377\000\310\000\377"
    "\000\310\000\377\000\310\000\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\377\000\000\377\377\000\000\377\377\000\000\377\377\000\000\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377"
    "\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353"
    "\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\310\000\377\000\310\000\377"
    "\000\310\000\377\000\310\000\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\377\000\000\377\377\000\000\377\377\000\000\377\377\000\000\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377"
    "\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353"
    "\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\310\000\377\000\310\000\377"
    "\000\310\000\377\000\310\000\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\377\000\000\377\377\000\000\377\377\000\000\377\377\000\000\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377"
    "\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353"
    "\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377"
    "\214\214\214\377\214\214\214\377\353\353\353\377\353\353\353\377\000\377\000"
    "\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214"
    "\214\214\377\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214"
    "\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353"
    "\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000"
    "\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353\353\353\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214"
    "\377\214\214\214\377\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000"
    "\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000"
    "\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000"
    "\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000"
    "\377\000\377\000\377\353\353\353\377\353\353\353\377\353\353\353\377\214\214"
    "\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214"
    "\377\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214"
    "\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353"
    "\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000"
    "\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353\353\353\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214"
    "\214\377\214\214\214\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377\000"
    "\377\000\377\000\377\353\353\353\377\353\353\353\377\353\353\353\377\214\214"
    "\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214"
    "\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000"
    "\377\214\214\214\377\214\214\214\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000"
    "\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377"
    "\214\214\214\377\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\353\353\353\377\353\353\353\377\353\353\353\377\214\214\214"
    "\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377"
    "\353\353\353\377\353\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\214\214\214\377\214\214\214\377"
    "\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214\377\353\353\353\377\353"
    "\353\353\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000"
    "\377\214\214\214\377\214\214\214\377\353\353\353\377\353\353\353\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377\000\377"
    "\000\377\000\377\000\377\000\377\000\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377"
    "\214\214\214\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353"
    "\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377"
    "\214\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214"
    "\214\214\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353"
    "\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353"
    "\377\353\353\353\377\353\353\353\377\353\353\353\377\353\353\353\377\214"
    "\214\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377"
    "\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214"
    "\214\377\214\214\214\377\000\000\000\377\000\000\000\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214"
    "\214\214\377\214\214\214\377\214\214\214\377\214\214\214\377\214\214\214"
    "\377\214\214\214\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000"
    "\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000"
    "\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000"
    "\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377"
    "\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377\000\000\000\377"
    };

    m_window->setIcon(gimp_image.width, gimp_image.height, gimp_image.pixel_data);
}
